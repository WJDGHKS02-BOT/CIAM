<!--
    accountObject
    companyObject
    companySearchEnabled
    channel
    registration
-->

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="invitationInformation">

    <form class="member_content"
          id="memberContentForm"
          method="POST"
          th:action="@{/myPage/inviteCompanyAndAccountCreated}">
        <input name="channel"
               th:value="${channel}"
               type="hidden">

        <div class="inner_white"
             th:if="${companyObject != null && companyObject.registerCompany != null && accountObject != null}">
            <!-- Tab -->
            <div class="tab_nav">
                <ul class="tab_list"
                    role="tablist">
                    <li class="is_active"
                        id="companyInfoTab"
                        onclick="setActive(this)"
                        role="tab">
                        <button class="btn"
                                type="button"><span th:text="#{selfregisteration.companyInformation}">Company Information</span>
                        </button>
                    </li>
                    <li id="userInfoTab"
                        onclick="clickedNextBtn(this)"
                        role="tab">
                        <button class="btn"
                                type="button"><span th:text="#{selfregisteration.userInformation}">User Information</span></button>
                    </li>
                </ul>
            </div>
            <!-- //Tab -->

            <!-- Company Information : START -->
            <div id="companyInfo">
                <input id="bpid"
                       name="bpid"
                       th:value="${companyObject.registerCompany['bpid'] != null ? companyObject.registerCompany['bpid'] : ''}"
                       type="hidden">
                <input id="source"
                       name="source"
                       th:value="${companyObject.registerCompany['source'] != null ? companyObject.registerCompany['source'] : ''}"
                       type="hidden">
                <input id="type"
                       name="type"
                       th:value="${companyObject.registerCompany['type'] != null ? companyObject.registerCompany['type'] : ''}"
                       type="hidden">
                <input id="validStatus"
                       name="validStatus"
                       th:value="${companyObject.registerCompany['validStatus'] != null ? companyObject.registerCompany['validStatus'] : ''}"
                       type="hidden">
                <input type="hidden" name="isNewCompany" id="isNewCompany" value="false" >
                <input type="hidden" name="dunsno" id="dunsno"
                       th:value="${companyObject.registerCompany['dunsNo'] != null ? companyObject.registerCompany['dunsNo'] : ''}">

                <h3>General Information</h3>
                <ul class="mem_form_list2">
                    <li>
                        <p class="tit requ" th:text="#{selfregisteration.companyName}">Company Name</p>
                        <div class="col_wrap2">
                            <div class="inp_sec">
                                <input type="text" name="name" id="name"
                                       th:value="${companyObject.registerCompany['name'] != null ? companyObject.registerCompany['name'] : ''}"
                                       th:readonly="${!companySearchEnabled}" placeholder="Company Name" class="input" maxlength="300" required>
                            </div>
                            <div class="bt_sec" th:if="${companySearchEnabled}">
                                <button id="resetBtn" type="button" class="btn_l btn_gray" onclick="resetCompanyInformationField()" th:text=#{selfregisteration.reset}>Reset</button>
                                <button id="searchCompany" type="button" class="btn_l" onclick="onSearchCompany()" th:text="#{selfregisteration.searchCompany}">Search company</button>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="col_wrap1">
                            <div>
                                <p class="tit requ" th:text="#{selfregisteration.businessLocation}">Business Location</p>
                                <select name="country" id="country" th:disabled="${!companySearchEnabled}"
                                        class="select" required readonly="readonly">
                                    <!--                                    <option value="" th:text="#{selfregisteration.selectOption}"></option>-->
                                    <option th:each="location: ${companyObject.countries}" th:if="${location != null}"
                                            th:value="|${location.countryCode}|" th:utext="${location.country}"
                                            th:selected="${location.countryCode == companyObject.registerCompany['country']}"></option>
                                </select>
                                <input id="countryHidden" name="country" type="hidden"
                                       th:value="${companyObject.registerCompany['country'] != null ? companyObject.registerCompany['country'] : ''}">
                            </div>
                            <div>
                                <p class="tit" th:text="#{selfregisteration.subsidiary}">Subsidiary</p>
                                <select name="subsidiary" id="subsidiary" class="select wid_ty4"
                                        th:aria-readonly="${myRole == 'Partner Admin'}">
                                    <option th:each="curSubsidiary: ${subsidiarys}"
                                            th:if="${curSubsidiary != null}"
                                            th:value="${curSubsidiary}"
                                            th:utext="${curSubsidiary}">
                                    </option>
                                </select>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="col_wrap1">
                            <div>
                                <p class="tit" th:text="#{selfregisteration.state}">State</p>
                                <input type="text" name="state" id="state"
                                       th:value="${companyObject.registerCompany['state'] != null ? companyObject.registerCompany['state'] : ''}"
                                       placeholder="" class="input" maxlength="50" readonly>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="col_wrap1">
                            <div>
                                <p class="tit" th:text="#{selfregisteration.region}">Region</p>
                                <input type="text" name="region" id="region"
                                       th:value="${companyObject.registerCompany['region'] != null ? companyObject.registerCompany['region'] : ''}"
                                       placeholder="" class="input" maxlength="50" readonly>
                            </div>
                            <div>
                                <p class="tit" th:text=#{selfregisteration.city}>City</p>
                                <input type="text" name="city" id="city"
                                       th:value="${companyObject.registerCompany['city'] != null ? companyObject.registerCompany['city'] : ''}"
                                       placeholder="" class="input" maxlength="70" readonly>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="col_wrap1">
                            <div>
                                <p class="tit" th:text="#{selfregisteration.street}">Street</p>
                                <input type="text" name="street_address" id="street_address"
                                       th:value="${companyObject.registerCompany['street_address'] != null ? companyObject.registerCompany['street_address'] : ''}"
                                       placeholder="" class="input" maxlength="100" readonly>
                            </div>
                            <div>
                                <p class="tit" th:text="#{selfregisteration.postalCode}">Postal Code</p>
                                <input type="text" name="zip_code" id="zip_code"
                                       th:value="${companyObject.registerCompany['zip_code'] != null ? companyObject.registerCompany['zip_code'] : ''}"
                                       placeholder="" class="input" maxlength="10" readonly>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="col_wrap1">
                            <div>
                                <p class="tit" th:text="#{selfregisteration.phoneNumber1}">Company Phone Number</p>
                                <input type="text" name="phonenumber1" id="phonenumber1"
                                       th:value="${companyObject.registerCompany['phonenumber1'] != null ? companyObject.registerCompany['phonenumber1'] : ''}"
                                       placeholder="" class="input" maxlength="40" readonly>
                                <!-- 24.07.15 phoneNumberValidation 클래스 제거 -->
                                <!-- placeholder="" class="input phoneNumberValidation" maxlength="40" readonly> -->
                            </div>
                            <div>
                                <p class="tit" th:text="#{selfregisteration.fax}">Company Fax</p>
                                <input type="text" name="fax" id="fax"
                                       th:value="${companyObject.registerCompany['fax'] != null ? companyObject.registerCompany['fax'] : ''}"
                                       placeholder="" class="input" maxlength="40" readonly>
                                <!-- 24.07.15 phoneNumberValidation 클래스 제거 -->
                                <!-- placeholder="" class="input phoneNumberValidation" maxlength="40" readonly> -->
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="col_wrap1">
                            <div>
                                <p class="tit" th:text="#{selfregisteration.mfaEmailText}">Business Email</p>
                                <input type="text" name="email" id="email"
                                       th:value="${companyObject.registerCompany['email'] != null ? companyObject.registerCompany['email'] : ''}"
                                       placeholder="" class="input" maxlength="100" readonly>
                                <!-- 24.07.15 emailValidation 클래스 제거 -->
                                <!-- placeholder="" class="input emailValidation" maxlength="100" readonly> -->
                            </div>
                            <div>
                                <p class="tit" th:text="#{selfregisteration.businessLicenseNumber}">Business License Number</p>
                                <input type="text" name="bizregno1" id="bizregno1"
                                       th:value="${companyObject.registerCompany['bizregno1'] != null ? companyObject.registerCompany['bizregno1'] : ''}"
                                       placeholder="" class="input" maxlength="20" readonly>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="col_wrap1">
                            <div>
                                <p class="tit" th:text="#{selfregisteration.representative}">Representative</p>
                                <input type="text" name="representative" id="representative"
                                       th:value="${companyObject.registerCompany['representative'] != null ? companyObject.registerCompany['representative'] : ''}"
                                       placeholder="" class="input" maxlength="14" readonly>
                            </div>
                            <div>
                                <p class="tit requ" th:text="#{selfregisteration.accountId}">Account ID</p>
                                <input type="text" name="vendorcode" id="vendorcode"
                                       th:value="${companyObject.registerCompany['vendorcode'] != null ? companyObject.registerCompany['vendorcode'] : ''}"
                                       placeholder="" class="input" maxlength="255" readonly required>
                            </div>
                        </div>
                    </li>
                </ul>

                <div class="bt_wrap1">
                    <button class="btn_l next"
                            id="companyInfoNextBtn"
                            onclick="clickedNextBtn(this)"
                            th:text="#{selfregisteration.next}"
                            type="button">Next
                    </button>
                </div>
            </div>
            <!-- Company Information : END -->

            <!-- User Information Start -->
            <div id="userInfo"
                 style="display: none;">
                <h3>General Information</h3>
                <ul class="mem_form_list2">
                    <li>
                        <p class="tit requ"
                           th:text="#{selfregisteration.loginId}">Login ID</p>
                        <input class="input"
                               id="loginUserId"
                               maxlength="100"
                               name="loginUserId"
                               placeholder=""
                               required
                               type="text">
                        <p id="loginUserIdError"></p>
                    </li>
                    <li>
                        <div class="col_wrap1">
<!--                            <div>-->
<!--                                <p class="tit"-->
<!--                                   th:text="#{selfregisteration.salutation}">Salutation</p>-->
<!--                                <input class="input"-->
<!--                                       id="salutation"-->
<!--                                       name="salutation"-->
<!--                                       placeholder=""-->
<!--                                       type="text">-->
<!--                            </div>-->
                            <div>
                                <p class="tit"
                                   th:text=#{selfregisteration.preferredLanguage}>Preferred Language</p>
                                <select class="select"
                                        id="language"
                                        name="language">
                                    <option value="">-- select --</option>
                                    <option th:each="language: ${accountObject?.languages}"
                                            th:if="${language != null}"
                                            th:utext="${language.name}"
                                            th:value="${language.value}"></option>
                                </select>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="col_wrap1">
                            <div>
                                <p class="tit"
                                   th:text="#{selfregisteration.firstName}">First Name</p>
                                <input class="input"
                                       id="firstName"
                                       maxlength="100"
                                       name="firstName"
                                       placeholder=""
                                       type="text">
                                <p id="firstNameError"></p>
                            </div>
                            <div>
                                <p class="tit"
                                   th:text=#{selfregisteration.lastName}>Last Name</p>
                                <input class="input"
                                       id="lastName"
                                       maxlength="40"
                                       name="lastName"
                                       placeholder=""
                                       type="text">
                                <p id="lastNameError"></p>
                            </div>
                        </div>
                    </li>
                    <li>
                        <p class="tit"
                           th:text="#{selfregisteration.phone}">Phone</p>
                        <div class="col_wrap4">
                            <select class="select"
                                    id="country_code_work"
                                    name="country_code_work"
                            <option value="">-</option>
                            <option th:each="code: ${accountObject?.codes}"
                                    th:if="${code != null}"
                                    th:selected="${code.code == accountObject['country_code_work']}"
                                    th:utext="|(+${code.code}) ${code.name}|"
                                    th:value="${code.code}"></option>
                            </select>
                            <input id="country_code_work_Hidden"
                                   name="country_code_work"
                                   type="hidden">

                            <input class="input phoneNumberValidation"
                                   id="work_phone"
                                   maxlength="40"
                                   name="work_phone"
                                   placeholder=""
                                   type="text">
                        </div>
                    </li>
                    <li>
                        <div class="col_wrap1">
                            <div>
                                <p class="tit"
                                   th:text="#{selfregisteration.department}">Department</p>
                                <select class="select"
                                        id="secDept"
                                        name="secDept">
                                    <option value="">-- select --</option>
                                    <option th:each="division: ${accountObject?.divisions}"
                                            th:if="${division != null}"
                                            th:utext="${division.name}"
                                            th:value="${division.value}"></option>
                                </select>
                            </div>
                            <div>
                                <p class="tit"
                                   th:text="#{selfregisteration.jobTitle}">Job Title</p>
                                <input class="input"
                                       id="job_title"
                                       name="job_title"
                                       placeholder=""
                                       type="text">
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="col_wrap1">
                            <div>
                                <p class="tit"
                                   th:text="#{invitation.channel}">Channel</p>
                                <select class="select"
                                        id="channel"
                                        name="channel" disabled>
                                    <option th:each="channel: ${channels}"
                                            th:if="${channel != null}"
                                            th:utext="${channel.channelDisplayName}"
                                            th:value="${channel.channelName}">
                                    </option>
                                </select>
                            </div>
                            <div>
                                <p class="tit"
                                   th:text="#{selfregisteration.role}">Role</p>
                                <select class="select"
                                        id="role"
                                        name="role">
                                    <option th:each="role: ${accountObject?.roles}"
                                            th:if="${role != null}"
                                            th:utext="${role.name}"
                                            th:value="${role.code}"></option>
                                </select>
                            </div>
                        </div>
                    </li>
                </ul>

                <div class="bt_wrap4">
                    <button class="btn_l back"
                            id="backCompanyInfoBtn"
                            onclick="setActive(this)"
                            th:text="#{selfregisteration.back}"
                            type="button">Back
                    </button>
                    <button class="btn_l next"
                            id="userInfoNextBtn"
                            onclick="clickedNextBtn(this)"
                            th:text="#{selfregisteration.confirm}"
                            type="button">Confirm
                    </button>
                </div>

            </div>
            <!-- User Information End -->

            <!-- Hidden Fields Start -->
            <button id="submit"
                    type="submit"></button>
            <!-- Hidden Fields End -->
        </div>
    </form>
    </div>

    <th:block th:if="${companySearchEnabled}">
        <button type="button"
                onclick="onSearchCompany()"
                class="btn">Search Company</button>
    </th:block>

    <th:block th:replace="~{${searchCompanyModal}}"></th:block>


</th:block>

<!-- i18n 메시지 변수 -->
<script th:inline="javascript">
    const createAlertMessage = [[#{myPage.inviteUser.createAlertMessage}]];
    const createSuccessMessage = [[#{myPage.inviteUser.createSuccessMessage}]];
    const createErrorMessage = [[#{myPage.inviteUser.createErrorMessage}]];
</script>

<script th:inline="javascript" type="text/javascript">
    const loginIdErrorElement = document.querySelector('#loginUserIdError');
    const companyInfoComponent = document.getElementById('companyInfo');
    const userInfoComponent = document.getElementById('userInfo');
    const companyInfoTab = document.getElementById('companyInfoTab');
    const userInfoTab = document.getElementById('userInfoTab');
    const resetCompanyName = document.getElementById('resetBtn');
    const companyName = document.getElementById('name');
    const country = document.getElementById("country");
    const countryHidden = document.getElementById("countryHidden");
    const submitBtn = document.getElementById("submit");
    const vendorCodeField = document.getElementById("vendorcode") ?? false;
    const rejecteDomains = /*[[${rejecteDomains != null ? rejecteDomains : '[]'}]]*/ [];

    const errorInputClass = "inp_error";
    const txtErrorClass = "txt_inp_error";

    const phoneNumberRegex = /^[0-9-+\s]/;
    const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z]{2,3}$/i;
    const characterRegex = /^[가-힣a-zA-Z]/;

    const notIncludeCompanySelectFields = [
        // "country"
    ];


    let emailComponent = [
        // '#email',
        '#loginUserId'
    ];

    // 필수 필드들의 Validatied 상태값
    const isValidated = {
        "loginUserId": false
    };

    let duplicateCheckComponent = [
        'loginUserId'
    ];

    let count = 0;

    emailComponentString = emailComponent.toString();

    const inValidMessages = {
        "emailFormat": "Must be using email format",
        "duplIdErrorText": [[#{registration.duplicateIdErrorText}]] || '',
        "duplIdAlertText": [[#{registration.duplicateIdAlertText}]] || '',
        "agreeTerms": "Please agree to the terms",
        "samsungEmail": "If you are a Samsung employee, please log in using the 'Samsung Employee Login' menu.",
    };

    const samsungEmails = [
        "@samsung.com",
        '@partner.samsung.com',
    ];

    const classList = [
        "txt_inp_error"
    ];

    const loginErrorElement = document.querySelector('#loginUserIdError');


    $(document).on('input', emailComponentString, async (event) => {
        const target = event.target;
        const value = target.value;
        const id = target.id;


        const validationTextId = id + "Error";
        const validText = document.getElementById(validationTextId);

        // 메일 형식 체크
        if (emailRegex.test(value)) {
            console.log('is email format');
            if (duplicateCheckComponent.includes(id)) {
                count += 1;
                isValidated[id] = false;
                await emailDuplicateCheck(id, validText, value, count);
                return;
            }
        } else {
            console.log('is not email format');
            loginErrorElement.innerText = inValidMessages['emailFormat'];
            loginErrorElement.className = 'txt_inp_error';
            // addClassList(validText, classList);
            isValidated[id] = false;
        }
    });

    // Email 중복 체크
    async function emailDuplicateCheck(targetId, validText, value, curCount) {
        console.log('중복 체크');
        let params = {};
        params[targetId] = value;
        let paramsString = JSON.stringify(params);

        if (curCount == count) {
            const checkUserIdResult = await checkUserId(paramsString);

            if (!checkUserIdResult) {
                isValidated[targetId] = false;
                validText.innerText = inValidMessages['duplIdErrorText'];
                addClassList(validText, classList);
            } else {
                await isSamsungEmail(loginUserId);
            }
        }
    }

    async function isSamsungEmail(target) {
        const id = target.id;
        const value = target.value;
        const errorTextId = id + "Error";
        const errorText = document.getElementById(errorTextId);

        const [_, domain] = value.split("@");

        function checkSamsungEmail () {
            if (rejecteDomains.includes(`@${domain}`)) {
                return true;
            }

            // @*.samsung.com 패턴 확인
            if (rejecteDomains.includes("@*.samsung.com")) {
                const regex = /^[a-zA-Z0-9._%+-]+@([a-zA-Z0-9-]+\.)?samsung\.com$/;
                return regex.test(value);
            }

            return false;
        }

        if (checkSamsungEmail()) {
            errorText.innerText = inValidMessages['samsungEmail'];
            addClassList(errorText, classList);
            isValidated[id] = false;
            count = 0;
        } else {
            errorText.innerText = '';
            removeClassList(errorText, classList);
            isValidated[id] = true;
        }
    };

    function addClassList(component, classList) {
        for (let value of classList) {
            component.classList.add(`${value}`);
        }
    }

    const companyValidationFields = {
        // "phonenumber1": false,
        // "fax": false,
        // "email": false,
        "name": false,
        "country": false,
        "companySearch": false,
        "vendorcode": false,
    };

    const userValidationFields = {
        "loginUserId": false
    };

    const isNumberCheckFileds = [
        "phonenumber1",
        "fax",
    ];

    const userPhoneValidation = [
        "country_code_work",
        "work_phone"
    ];

    function getValidationFields(target) {
        let fields = {};

        if (target.includes("company")) {
            fields = companyValidationFields;
        } else if (target.includes("user")) {
            fields = userValidationFields;
        }
        return fields;
    }

    function addErrorInputClass(target) {
        target.classList.add(errorInputClass);
    }

    function removeErrorInputClass(target) {
        target.classList.remove(errorInputClass);
    }

    // Eamil 중복 체크 - Call Backend API
    async function checkUserId(paramsString) {
        const result = await $.ajax({
            url: "/registration/checkUserId",
            type: "POST",
            data: paramsString,
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function(data){
                data.errorCode === 0 ? loginIdErrorElement.className = '' :loginIdErrorElement.className = 'txt_inp_error';
            },
            error: function(error){
            }
        });

        if (result && result.errorCode == '0' && result.status == 'available') {
            return true;
        } else {
            return false;
        }
    }

    // 전화번호 유효성 검증
    async function phoneNumberValidation(target) {
        let fields = getValidationFields(target);

        const phoneNumberFormFields = document.querySelector(target).querySelectorAll(".phoneNumberValidation");
        if (!!phoneNumberFormFields) {
            await phoneNumberFormFields.forEach((component) => {
                let value = component.value;
                let id = component.id;
                if (!!value && !phoneNumberRegex.test(value)) {
                    addErrorInputClass(component);
                    component.focus();
                    fields[id] = false;
                } else {
                    removeErrorInputClass(component);
                    fields[id] = true;
                }
            });
        }
    }

    // 이메일 유효성 검증
    async function emailValidation(target) {
        let fields = getValidationFields(target);

        const emailFormFields = document.querySelector(target).querySelectorAll(".emailValidation");
        if (!!emailFormFields) {
            await emailFormFields.forEach((component) => {
                let value = component.value;
                let id = component.id;
                if (!!value && !emailRegex.test(value)) {
                    addErrorInputClass(component);
                    component.focus();
                    fields[id] = false;
                } else {
                    removeErrorInputClass(component);
                    fields[id] = true;
                }
            });
        }
    }

    // target 활성화
    function setActive(target) {
        const id = target.id.toLowerCase();

        if (id.includes('user')) {
            companyInfoComponent.style.display = 'none';
            userInfoComponent.style.display = 'block';

            companyInfoTab.classList.remove("is_active");
            userInfoTab.classList.add("is_active");
        } else if (id.includes('company')) {
            companyInfoComponent.style.display = 'block';
            userInfoComponent.style.display = 'none';

            companyInfoTab.classList.add("is_active");
            userInfoTab.classList.remove("is_active");
        }
    }

    // 필수 필드 값 검증
    async function checkRequiredFields(target) {
        let fields = getValidationFields(target);

        const requiredFields = document.querySelector(target).querySelectorAll("[required]");
        if (!!requiredFields) {
            await Object.entries(requiredFields).map(([key, component]) => {
                let value = component.value;
                let id = component.id;
                if (!value) {
                    if (id === "searchCompany") {
                        component = companyName;
                        fields["name"] = false;
                        addErrorInputClass(component);
                        component.focus();
                    } else {
                        fields[id] = false;
                        addErrorInputClass(component);
                        component.focus();
                    }
                } else {
                    removeErrorInputClass(component);
                    fields[id] = true;
                }
            });
        }
    }

    async function characterValidation(target) {
        console.log('문자 유효성 검증');
        let fields = getValidationFields(target);

        const characterFormFields = document.querySelector(target).querySelectorAll(".characterValidation");
        if (!!characterFormFields) {
            await characterFormFields.forEach((component) => {
                let value = component.value;
                let id = component.id;

                const errorMsgId = id + "Error";
                const errorMsgText = document.getElementById(errorMsgId);
                if (!value || !characterRegex.test(value)) {
                    addErrorInputClass(component);
                    component.focus();

                    errorMsgText.classList.add(txtErrorClass);
                    errorMsgText.innerText = "The name field must only contain letters";

                    fields[id] = false;
                } else {
                    removeErrorInputClass(component);

                    errorMsgText.classList.remove(txtErrorClass);
                    errorMsgText.innerText = "";

                    fields[id] = true;
                }
            });
        }
    }

    // validation 상태값 체크
    async function checkFieldsValidated(target) {
        let fields = getValidationFields(target);

        for (let key in fields) {
            if (!fields[key]) {
                console.log('invalid key:', key);
                return false;
            }
        }

        return true;
    }

    // company search validation check
    function isSearchCompanyBtnClicked() {
        const value = countryHidden.value;
        if (!!value) {
            companyValidationFields["companySearch"] = true;
        }
    }

    // target에 해당하는 Information 전체 필드들의 Validation 상태 체크
    // target = "company" or "user"
    async function validationCheck(target) {
        const idString = `#${target}`;

        isSearchCompanyBtnClicked();
        await checkRequiredFields(idString);
        await phoneNumberValidation(idString);
        await emailValidation(idString);
        await characterValidation(idString);

        if (!(await checkFieldsValidated(target))) {
            return false;
        } else {
            console.log('success validation!');
            return true;
        }
    }

    // 필드 Reset
    // clickedResetBtn과 연결됨
    function resetAllFields(id, validationFields, type) {
        const fields = document.querySelector(id).querySelectorAll(type);

        for (let component of fields) {
            let currentComponentId = component.id;
            let currentValidation = validationFields[currentComponentId];
            if (!!currentValidation) {
                currentValidation = false;
            }
            component.value = "";
        }
    }

    // Reset Button
    function clickedResetBtn() {
        companyName.value = '';
        companyName.readOnly = false;
        companyValidationFields["companySearch"] = false;
        const id = "#companyInfo";

        resetAllFields(id, companyValidationFields, "input");
        resetAllFields(id, companyValidationFields, "select");
    }

    // Next Button
    async function clickedNextBtn(target) {
        const id = target.id;
        let clickedId = "";

        if (target.id.includes("Tab")) {
            clickedId = "companyInfo";
        } else {
            clickedId = target.id.includes("companyInfo") ? "companyInfo" : "userInfo" ;
        }

        const good = await validationCheck(clickedId);
        if (good) {
            if (clickedId === "companyInfo") {
                countryHidden.value = country.value;
                setActive(userInfoTab);
            } else {
                // isNewCompany 값을 체크
                var isNewCompany = $("#isNewCompany").val();

                if (isNewCompany === "true") {
                    // isNewCompany가 "true"일 때는 중복 체크를 수행
                    checkCompanyDuplicate();
                } else {
                    // isNewCompany가 "true"가 아니면 바로 폼을 제출
                    submitBtn.click();
                }
            }
        } else {
            return false;
        }
    }

    function checkCompanyDuplicate() {
        var dunsNo = $("#dunsno").val();
        var isNewCompany = $("#isNewCompany").val();
        var bizRegNo1 = $("#bizregno1").val();
        var country = $("#country").val();
        // isNewCompany가 "true"이고 bizRegNo1 값이 비어있지 않을 때만 중복 체크 수행
        if (isNewCompany === "true" && bizRegNo1) {
            $.ajax({
                url: "/search/checkCompanyDuplicate",
                type: "POST",
                data: JSON.stringify({
                    name: $("#name").val(),
                    bizregno1: bizRegNo1,
                    dunsno: dunsNo,
                    channel: $("input[name='channel']").val(),
                    isNewCompany: isNewCompany,
                    country : country
                }),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(res) {
                    const backButton = document.getElementById("backCompanyInfoBtn");

                    if (res.result === "duplicate") {
                        function handleReCheckBusinessLicenseNumber () {
                            const searchAccountIdField  = document.getElementById('filter_accountId');

                            ModalAlertClose('#errorModal')
                            backButton.click();
                            ModalOpen("#searchCompanyModal");

                            searchAccountIdField.value = res.accountId;

                            doSearchCompany();
                        }

                        openModal('error', handleReCheckBusinessLicenseNumber, String(res.msg));
                    } else if (res.result === 'validationError') {
                        function handleAlreadyExistBusinessLicenseNumber () {
                            ModalAlertClose('#errorModal')
                            backButton.click();
                        }

                        openModal('error', handleAlreadyExistBusinessLicenseNumber, String(res.msg));
                    } else {
                        // 중복이 없을 경우 폼 제출
                        submitBtn.click();
                    }
                },
                error: function(error) {
                    console.error("Error checking company duplicate:", error);
                }
            });
        } else {
            // isNewCompany가 "true"가 아니거나 bizRegNo1 값이 비어있을 경우 폼을 제출
            submitBtn.click();
        }
    }

    // submit 이벤트 리스너
    $(document).on('submit', "form", async (e) => {
        e.preventDefault();

        const form = e.target;
        const formData = new FormData(form);

        ModalAlertOpen("#loadingPopup");

        try {
            const res = await fetch(form.action, {
                method: form.method,
                body: formData,
            })

            if (res.ok) openModal('success', () => window.location.href = '/myPage/inviteUser', createSuccessMessage);
            else openModal('error', '', createErrorMessage);

            ModalAlertClose("#loadingPopup");
        } catch (error) {
            loading("close");
            ModalAlertClose("#loadingPopup");
        }
    });

    // Open Company Search Popup
    function onSearchCompany() {
        // reference file : ~/scripts/searchCompany.js
        executeSearchCompany();
    }

    // search company를 통해 선택된 회사 정보를 Company information 필드들에 매칭
    function setCompanyInformation(oCompanyInfo) {
        console.debug("oCompanyInfo :: ", oCompanyInfo);

        // different name
        $('#fax').val(oCompanyInfo.faxno || '');
        $('#street_address').val(oCompanyInfo.streetAddress || oCompanyInfo.streetGl || '');
        // $('#zip_code').val(oCompanyInfo.zipCode || '');

        companyName.readOnly = true;
        companyValidationFields["companySearch"] = true;

        for (let key in oCompanyInfo) {
            const currentValue = oCompanyInfo[key];
            const matachedComponent = document.getElementById(key);
            if (!!matachedComponent && !notIncludeCompanySelectFields.includes(key)) {
                matachedComponent.dispatchEvent(new Event('input', {bubbles: true}));
                matachedComponent.value = currentValue || '';
            }
        }

        if (oCompanyInfo.dnbListYn) {
            const vendorCodeElement = document.getElementById("vendorcode");
            companyValidationFields['vendorcode'] = true;
            if (vendorCodeElement) {
                // 필수 속성 해제
                vendorCodeElement.required = false;
                isNewCompanyElement.value = "true";

                // 부모 요소 내의 'p' 태그에서 'requ' 클래스를 제거
                const pElement = vendorCodeElement.parentNode.querySelector('p');
                if (pElement) {
                    pElement.classList.remove('requ');
                }
            }
        } else {
            const vendorCodeElement = document.getElementById("vendorcode");
            companyValidationFields['vendorcode'] = false
            if (vendorCodeElement) {
                // 필수 속성 해제
                vendorCodeElement.required = true;
                isNewCompanyElement.value = false;

                // 부모 요소 내의 'p' 태그에서 'requ' 클래스를 제거
                const pElement = vendorCodeElement.parentNode.querySelector('p');
                if (pElement) {
                    pElement.classList.add('requ');
                }
            }
        }
    }

    function resetFieldValue (element) {
        if(element.id === 'isNewCompany' || element.id === 'country') return;

        if (element.tagName.toLowerCase() === 'input') element.value = '';
        else if (element.tagName.toLowerCase() === 'select') {
            element.selectedIndex = 0;
        }
    }

    function resetCompanyInformationField () {
        Object.keys(companyValidationFields).forEach(key => {
            companyValidationFields[key] = false;
        });

        const createCompanyButtonElement = document.querySelector('#createCompanyButton');

        vendorCodeField.required = true;
        const pElement = vendorCodeField.parentNode.querySelector('p');
        pElement.classList.add('requ');

        switchDisplay("selectCompanyBtn", false);
        switchDisplay("noDataResult", false);
        const fieldsElement = document.querySelectorAll('#companyInfo input, #companyInfo select');
        const isNewCompanyElement = document.querySelector('#isNewCompany');

        const isCompanyCreating = isNewCompanyElement.value;

        fieldsElement.forEach(element => {
            resetFieldValue(element);
            element.readOnly = 'readonly';
            if(element.id === 'name') return element.removeAttribute('readonly');
        });

        if (isCompanyCreating) isNewCompanyElement.value = false;
        else {
            isNewCompanyElement.value = true;
            createCompanyButtonElement.classname = 'btn_m';
        }
    }

    // 모든 Select와 Input 태그에 input 이벤트 추가
    // 필드 Validation
    $(document).on('input', "select, input", async (event) => {;
        const target = event.target;
        const id = target.id;

        const errorMsgId = id + "Error";
        const errorMsgText = document.getElementById(errorMsgId);

        if (id === 'bizregno1') {
            const countryCode = document.getElementById('country').value;

            if(countryCode === 'KR') {
                let inputValue = target.value.replace(/\D/g, '');
                inputValue = inputValue.slice(0, 10);
                target.value = inputValue;
            }
            if (target.classList.contains(errorInputClass)) {
                removeErrorInputClass(target);
            }
            if (!!errorMsgText) {
                if (errorMsgText.classList.contains(txtErrorClass)) {
                    errorMsgText.classList.remove(txtErrorClass);
                    errorMsgText.innerText = '';
                }
            }

        } else {
            if (target.classList.contains(errorInputClass)) {
                removeErrorInputClass(target);
            }
            if (!!errorMsgText) {
                if (errorMsgText.classList.contains(txtErrorClass)) {
                    errorMsgText.classList.remove(txtErrorClass);
                    errorMsgText.innerText = '';
                }
            }
        }
        // console.log('필드 밸리데이션')
        // const target = event.target;
        // const id = target.id;
        //
        // const errorMsgId = id + "Error";
        // const errorMsgText = document.getElementById(errorMsgId);
        // if (target.classList.contains(errorInputClass)) {
        //     console.log('필드 밸리데이션 에러 인풋 삭제')
        //     removeErrorInputClass(target);
        // }
        // if (!!errorMsgText) {
        //     if (errorMsgText.classList.contains(txtErrorClass)) {
        //         errorMsgText.classList.remove(txtErrorClass);
        //         errorMsgText.innerText = '';
        //         console.log('필드 밸리데이션 에러 텍스트 삭제')
        //     }
        // }
    });

    $(document).on('keydown', 'input', async (event) => {
        const keyCode = event.keyCode;
        const target = event.target;
        const id = target.id;
        const value = target.value;

        if (keyCode === 13) {
            event.preventDefault();
            if (id === "name") {
                const message = "please enter a company name";
                if (!value) {
                    setErrorModalMsg(message);
                    ModalAlertOpen('#errorDialogBox');
                    return;
                }
                onSearchCompany();
            }
        }

    });
</script>

</html>