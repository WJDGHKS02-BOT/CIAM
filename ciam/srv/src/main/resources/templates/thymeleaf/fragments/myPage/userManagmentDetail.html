

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="userManagmentDetail">

    <form class="member_content"
          id="memberContentForm">

        <div class="inner_white"
             th:if="${companyObject != null && companyObject.registerCompany != null && accountObject != null}">
            <!-- Tab -->
            <div class="tab_nav">
                <ul class="tab_list"
                    role="tablist">
                    <li class="is_active"
                        id="companyInfoTab"
                        onclick="setActive(this)"
                        role="tab">
                        <button class="btn"
                                type="button"><span th:text="#{selfregisteration.companyInformation}">Company Information</span>
                        </button>
                    </li>
                    <li id="userInfoTab"
                        onclick="clickedNextBtn(this)"
                        role="tab">
                        <button class="btn"
                                type="button"><span th:text="#{selfregisteration.userInformation}">User Information</span></button>
                    </li>
                </ul>
            </div>
            <!-- //Tab -->

            <!-- Company Information : START -->
            <div id="companyInfo">
                <input id="bpid"
                       name="bpid"
                       th:value="${companyObject.registerCompany['bpid'] != null ? companyObject.registerCompany['bpid'] : ''}"
                       type="hidden">
                <input id="source"
                       name="source"
                       th:value="${companyObject.registerCompany['source'] != null ? companyObject.registerCompany['source'] : ''}"
                       type="hidden">
                <input id="type"
                       name="type"
                       th:value="${companyObject.registerCompany['type'] != null ? companyObject.registerCompany['type'] : ''}"
                       type="hidden">
                <input id="validStatus"
                       name="validStatus"
                       th:value="${companyObject.registerCompany['validStatus'] != null ? companyObject.registerCompany['validStatus'] : ''}"
                       type="hidden">

                <h3>General Information</h3>
                <ul class="mem_form_list2">
                    <li>
                        <p class="tit requ" th:text="#{selfregisteration.companyName}">Company Name</p>
                        <div class="col_wrap2">
                            <div class="inp_sec">
                                <input type="text" name="name" id="name"
                                       th:value="${companyObject.registerCompany['name'] != null ? companyObject.registerCompany['name'] : ''}"
                                        placeholder="Company Name" class="input" maxlength="300" required readonly>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="col_wrap1">
                            <div>
                                <p class="tit requ" th:text="#{selfregisteration.businessLocation}">Business Location</p>
                                <select name="country" id="country"
                                        class="select" required disabled>
                                    <!--                                    <option value="" th:text="#{selfregisteration.selectOption}"></option>-->
                                    <option th:each="location: ${companyObject.countries}" th:if="${location != null}"
                                            th:value="|${location.countryCode}|" th:utext="${location.nameEn}"
                                            th:selected="${location.countryCode == companyObject.registerCompany['country']}"></option>
                                </select>
                            </div>
                            <div style="display: flex; flex-direction: column; justify-content: end">
                                <p class="tit" th:text="#{selfregisteration.state}">State</p>
                                <input type="text" name="state" id="state"
                                       th:value="${companyObject.registerCompany['state'] != null ? companyObject.registerCompany['state'] : ''}"
                                       placeholder="" class="input" maxlength="50" readonly>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="col_wrap1">
                            <div>
                                <p class="tit" th:text="#{selfregisteration.region}">Region</p>
                                <input type="text" name="region" id="region"
                                       th:value="${companyObject.registerCompany['region'] != null ? companyObject.registerCompany['region'] : ''}"
                                       placeholder="" class="input" maxlength="50" readonly>
                            </div>
                            <div>
                                <p class="tit" th:text=#{selfregisteration.city}>City</p>
                                <input type="text" name="city" id="city"
                                       th:value="${companyObject.registerCompany['city'] != null ? companyObject.registerCompany['city'] : ''}"
                                       placeholder="" class="input" maxlength="70" readonly>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="col_wrap1">
                            <div>
                                <p class="tit" th:text="#{selfregisteration.street}">Street</p>
                                <input type="text" name="street_address" id="street_address"
                                       th:value="${companyObject.registerCompany['street_address'] != null ? companyObject.registerCompany['street_address'] : ''}"
                                       placeholder="" class="input" maxlength="100" readonly>
                            </div>
                            <div>
                                <p class="tit" th:text="#{selfregisteration.postalCode}">Postal Code</p>
                                <input type="text" name="zip_code" id="zip_code"
                                       th:value="${companyObject.registerCompany['zip_code'] != null ? companyObject.registerCompany['zip_code'] : ''}"
                                       placeholder="" class="input" maxlength="10" readonly>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="col_wrap1">
                            <div>
                                <p class="tit" th:text="#{selfregisteration.phoneNumber1}">Company Phone Number</p>
                                <input type="text" name="phonenumber1" id="phonenumber1"
                                       th:value="${companyObject.registerCompany['phonenumber1'] != null ? companyObject.registerCompany['phonenumber1'] : ''}"
                                       placeholder="" class="input" maxlength="40" readonly>
                                <!-- 24.07.15 phoneNumberValidation 클래스 제거 -->
                                <!-- placeholder="" class="input phoneNumberValidation" maxlength="40" readonly> -->
                            </div>
                            <div>
                                <p class="tit" th:text="#{selfregisteration.fax}">Company Fax</p>
                                <input type="text" name="fax" id="fax"
                                       th:value="${companyObject.registerCompany['fax'] != null ? companyObject.registerCompany['fax'] : ''}"
                                       placeholder="" class="input" maxlength="40" readonly>
                                <!-- 24.07.15 phoneNumberValidation 클래스 제거 -->
                                <!-- placeholder="" class="input phoneNumberValidation" maxlength="40" readonly> -->
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="col_wrap1">
                            <div>
                                <p class="tit" th:text="#{selfregisteration.mfaEmailText}">Business Email</p>
                                <input type="text" name="email" id="email"
                                       th:value="${companyObject.registerCompany['email'] != null ? companyObject.registerCompany['email'] : ''}"
                                       placeholder="" class="input" maxlength="100" readonly>
                                <!-- 24.07.15 emailValidation 클래스 제거 -->
                                <!-- placeholder="" class="input emailValidation" maxlength="100" readonly> -->
                            </div>
                            <div>
                                <p class="tit" th:text="#{selfregisteration.businessLicenseNumber}">Business License Number</p>
                                <input type="text" name="bizregno1" id="bizregno1"
                                       th:value="${companyObject.registerCompany['bizregno1'] != null ? companyObject.registerCompany['bizregno1'] : ''}"
                                       placeholder="" class="input" maxlength="20" readonly>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="col_wrap1">
                            <div>
                                <p class="tit" th:text="#{selfregisteration.representative}">Representative</p>
                                <input type="text" name="representative" id="representative"
                                       th:value="${companyObject.registerCompany['representative'] != null ? companyObject.registerCompany['representative'] : ''}"
                                       placeholder="" class="input" maxlength="14" readonly>
                            </div>
                            <div>
                                <p class="tit requ"
                                   th:text="${type == 'CMDM'} ? #{selfregisteration.accountId} : #{selfregisteration.vendorCode}">
                                    Vendor Code
                                </p>
                                <input type="text" name="vendorcode" id="vendorcode"
                                       th:value="${companyObject.registerCompany['vendorcode'] != null ? companyObject.registerCompany['vendorcode'] : ''}"
                                       placeholder="" class="input" maxlength="255" readonly required>
                            </div>
                        </div>
                    </li>
                </ul>

                <!-- Additional Information Fields : START -->
                <th:block th:replace="fragments/registration/fields/add-spec-information-fields :: add-spec-information-fields(${fieldMap.channelCompanyAdditionalShortFieldList}, ${fieldMap.channelCompanyAdditionalLongFieldList}, 'additional')"></th:block>
                <!-- Additional Information Fields : END -->

                <!-- Specific Information Fields : START -->
                <th:block th:replace="fragments/registration/fields/add-spec-information-fields :: add-spec-information-fields(${fieldMap.channelCompanySpecShortFieldList}, ${fieldMap.channelCompanySpecLongFieldList}, 'specific')"></th:block>
                <!-- Specific Information Fields : END -->

                <div class="bt_wrap1">
                    <button class="btn_l next"
                            id="companyInfoNextBtn"
                            onclick="clickedNextBtn(this)"
                            th:text="#{selfregisteration.next}"
                            type="button">Next
                    </button>
                </div>
            </div>
            <!-- Company Information : END -->

            <!-- User Information Start -->
            <div id="userInfo"
                 style="display: none;">
                <h3>General Information</h3>
                <ul class="mem_form_list2">
                    <li>
                        <p class="tit requ"
                           th:text="#{selfregisteration.loginId}">Login ID</p>
                        <input class="input"
                               id="loginUserId"
                               maxlength="100"
                               name="loginUserId"
                               placeholder=""
                               required
                               readonly
                               th:value="${accountObject.loginId}"
                               type="text">
                        <p id="loginUserIdError"></p>
                    </li>
                    <li>
                        <div class="col_wrap1">
                            <!--                            <div>-->
                            <!--                                <p class="tit"-->
                            <!--                                   th:text="#{selfregisteration.salutation}">Salutation</p>-->
                            <!--                                <input class="input"-->
                            <!--                                       id="salutation"-->
                            <!--                                       name="salutation"-->
                            <!--                                       placeholder=""-->
                            <!--                                       type="text">-->
                            <!--                            </div>-->
                            <div>
                                <p class="tit"
                                   th:text=#{selfregisteration.preferredLanguage}>Preferred Language</p>
                                <select class="select"
                                        id="language"
                                        name="language"
                                        disabled>
                                    <option value="">-- select --</option>
                                    <option th:each="language: ${accountObject?.languages}"
                                            th:if="${language != null}"
                                            th:selected="${language.value == accountObject['language']}"
                                            th:utext="${language.name}"
                                            th:value="${language.value}"></option>
                                </select>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="col_wrap1">
                            <div>
                                <p class="tit"
                                   th:text="#{selfregisteration.firstName}">First Name</p>
                                <input class="input characterValidation"
                                       id="firstName"
                                       maxlength="100"
                                       name="firstName"
                                       placeholder=""
                                       th:value="${accountObject['firstName'] != null ? accountObject['firstName'] : ''}"
                                       type="text" readonly>
                                <p id="firstNameError"></p>
                            </div>
                            <div>
                                <p class="tit"
                                   th:text=#{selfregisteration.lastName}>Last Name</p>
                                <input class="input characterValidation"
                                       id="lastName"
                                       maxlength="40"
                                       name="lastName"
                                       placeholder=""
                                       th:value="${accountObject['lastName'] != null ? accountObject['lastName'] : ''}"
                                       type="text" readonly>
                                <p id="lastNameError"></p>
                            </div>
                        </div>
                    </li>
                    <li>
                        <p class="tit"
                           th:text="#{selfregisteration.phone}">Phone</p>
                        <div class="col_wrap4" style="gap: 10px;">
                            <select class="select"
                                    id="country_code_work"
                                    name="country_code_work" disabled>
                            <option value="">-</option>
                            <option th:each="code: ${accountObject?.codes}"
                                    th:if="${code != null}"
                                    th:selected="${code.code == accountObject['country_code_work']}"
                                    th:utext="|(+${code.code}) ${code.name}|"
                                    th:value="${code.code}"></option>
                            </select>
                            <input id="country_code_work_Hidden"
                                   name="country_code_work"
                                   type="hidden">

                            <input class="input phoneNumberValidation"
                                   id="work_phone"
                                   maxlength="40"
                                   name="work_phone"
                                   placeholder=""
                                   th:value="${accountObject['work_phone'] != null ? accountObject['work_phone'] : ''}"
                                   type="text" readonly>
                        </div>
                    </li>
                    <li>
                        <div class="col_wrap1">
                            <div>
                                <p class="tit"
                                   th:text="#{selfregisteration.department}">Department</p>
                                <select class="select"
                                        id="secDept"
                                        name="secDept" disabled>
                                    <option value="">-- select --</option>
                                    <option th:each="division: ${accountObject?.divisions}"
                                            th:if="${division != null}"
                                            th:selected="${division.value == accountObject['secDept']}"
                                            th:utext="${division.name}"
                                            th:value="${division.value}"></option>
                                </select>
                            </div>
                            <div>
                                <p class="tit"
                                   th:text="#{selfregisteration.jobTitle}">Job Title</p>
                                <input class="input"
                                       id="job_title"
                                       name="job_title"
                                       placeholder=""
                                       th:value="${accountObject['job_title'] != null ? accountObject['job_title'] : ''}"
                                       type="text" readonly>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="col_wrap1">
                            <div>
                                <p class="tit"
                                   th:text="#{invitation.channel}">Channel</p>
                                <select class="select"
                                        id="channel"
                                        name="channel" disabled>
                                    <option th:each="channel: ${channels}"
                                            th:if="${channel != null}"
                                            th:utext="${channel.channelDisplayName}"
                                            th:value="${channel.channelName}">
                                    </option>
                                </select>
                            </div>
                            <div>
                                <p class="tit"
                                   th:text="#{selfregisteration.role}">Role</p>
                                <select class="select"
                                        id="role"
                                        name="role"
                                        onchange="handleChangeRole()"
                                        onmousedown="this.value = ''; this.dispatchEvent(new Event('change'));"
                                        th:disabled="${accountObject['currentAdminRole'] == 'CIAM Admin' or accountObject['currentAdminRole'] == 'Channel Admin'} ? false : true">
                                    <option th:each="role: ${accountObject?.roles}"
                                            th:if="${role != null}"
                                            th:selected="${role.code == accountObject['userRole']}"
                                            th:utext="${role.name}"
                                            th:value="${role.code}">
                                    </option>
                                </select>
                            </div>
                        </div>
                    </li>
                </ul>

                <!-- Additional Information Fields : START -->
                <th:block th:replace="fragments/registration/fields/add-spec-information-fields :: add-spec-information-fields(${fieldMap.channelUserAdditionalShortFieldList}, ${fieldMap.channelUserAdditionalLongFieldList}, 'additional')"></th:block>

                <!-- Additional Information Fields : END -->

                <!-- Specific Information Fields : START -->
                <th:block th:replace="fragments/registration/fields/add-spec-information-fields :: add-spec-information-fields(${fieldMap.channelUserSpecShortFieldList}, ${fieldMap.channelUserSpecLongFieldList}, 'specific')"></th:block>
                <!-- Specific Information Fields : END -->

                <div class="bt_wrap4">
                    <button class="btn_l back"
                            id="backCompanyInfoBtn"
                            onclick="setActive(this)"
                            th:text="#{selfregisteration.back}"
                            type="button">Back
                    </button>
                    <button class="btn_l next"
                            id="userInfoNextBtn"
                            onclick="handleClickCellButton(this)"
                            th:if="${accountObject['currentAdminRole'] == 'CIAM Admin' or accountObject['currentAdminRole'] == 'Channel Admin'}"
                            th:text="#{selfregisteration.confirm}"
                            type="button">Confirm
                    </button>
                </div>

            </div>
        </div>
    </form>

    <script th:inline="javascript" type="text/javascript">
        var uid = [[${uid}]];

        const adminTypeSaveMessage = [[#{myPage.userManagment.adminTypeEdit}]];
        const adminTypeEditSuccessMessage = [[#{myPage.userManagment.adminTypeEditSuccessMessage}]];
        const adminTypeEditErrorMessage = [[#{myPage.userManagment.adminTypeEditErrorMessage}]];
        const companyInfoComponent = document.getElementById('companyInfo');
        const userInfoComponent = document.getElementById('userInfo');
        const companyInfoTab = document.getElementById('companyInfoTab');
        const userInfoTab = document.getElementById('userInfoTab');

        // target 활성화
        function setActive(target) {
            const id = target.id.toLowerCase();

            if (id.includes('user')) {
                companyInfoComponent.style.display = 'none';
                userInfoComponent.style.display = 'block';

                companyInfoTab.classList.remove("is_active");
                userInfoTab.classList.add("is_active");
            } else if (id.includes('company')) {
                companyInfoComponent.style.display = 'block';
                userInfoComponent.style.display = 'none';

                companyInfoTab.classList.add("is_active");
                userInfoTab.classList.remove("is_active");
            }
        }

        function handleClickCellButton (target) {
            const roleElement = document.getElementById('role');
            const channelElement = document.getElementById('channel');
            const roleText = roleElement.options[roleElement.selectedIndex].text;

            // selectedValues에서 수집된 값을 사용
            const countryValue = selectedValues.country;
            const subsidiaryValue = selectedValues.subsidiary;
            const divisionValue = selectedValues.division;
            const roleValue = roleElement.value;
            const channelValue = channelElement.value;
            // 선택된 옵션의 값 가져오기
            openModal('alert', () => {
                ModalAlertOpen("#loadingPopup");
                auditLogSave(channelValue, "User_Managment", "Role Modify", "", roleText);
                $.ajax({
                    url: "/myPage/adminTypeEdit",
                    type: 'POST',
                    data: JSON.stringify({
                        uid: uid,
                        role: roleValue,
                        channel: channelValue,
                        country: countryValue,
                        subsidiary: subsidiaryValue,
                        division: divisionValue
                    }),
                    contentType: "application/json; charset=utf-8",
                    dataType: 'text',
                    success: () => {
                        openModal('success', () => window.location.href = '/myPage/userManagment', adminTypeEditSuccessMessage)
                    },
                    error: (error) => {
                        openModal('error', '', adminTypeEditErrorMessage)
                    },
                    complete: () => ModalAlertClose("#loadingPopup")
                })
            }, adminTypeSaveMessage);
        }
        // Next Button
        async function clickedNextBtn(target) {
            const id = target.id;
            let clickedId = "";

            if (target.id.includes("Tab")) {
                clickedId = "companyInfo";
            } else {
                clickedId = target.id.includes("companyInfo") ? "companyInfo" : "userInfo";
            }

            if (clickedId === "companyInfo") {
                setActive(userInfoTab);
            }
        }

        $(document).on('submit', "form", async (e) => {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);

            ModalAlertOpen("#loadingPopup");

            try {
                const res = await fetch(form.action, {
                    method: form.method,
                    body: formData,
                })

                if (res.ok) openModal('success', () => window.location.href = '/myPage/inviteUser', createSuccessMessage);
                else openModal('error', '', createErrorMessage);

                ModalAlertClose("#loadingPopup");
            } catch (error) {
                loading("close");
                ModalAlertClose("#loadingPopup");
            }
        });

        function handleChangeRole() {
            const selectedRoleElement = document.querySelector('#role');

            selectedRoleElement.value === '2' && ModalOpen('#selectedRoleModal');
        }

        function auditLogSave(channel, type, action, reason,items) {
            let params = {
                channel: channel,
                type: type,
                action: action,
                items: items,
                reason: reason // 추가된 reason 파라미터
            };

            $.ajax({
                url: "/auditlog/create",
                type: "POST",
                data: JSON.stringify(params),
                contentType: "application/json; charset=utf-8",
                dataType: "text",
                success: function(response) {
                    console.log("Audit log saved successfully: " + response);
                },
                error: function(xhr, status, error) {
                    console.error("Error saving audit log: " + xhr.responseText);
                }
            });
        }
    </script>
    <div th:replace="~{popups/selected-role-modal}"></div>
</th:block>
</html>