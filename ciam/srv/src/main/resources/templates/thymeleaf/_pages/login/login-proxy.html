<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <link href="/_styles/_index.css" rel="stylesheet" />
    <link href="/_pages/login/login-page.css" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/_pages/login/sign-in-session.js"></script>
    <script src="/_components/spinner/loading-spinner.js"></script>
    <script th:inline="javascript">
      const GIGYA_API_KEY = [[${apiKey}]];
      const GIGYA_PARENT_KEYS = [[${parentKeys}]];
      const gigyaInstanceURL = [[${gigyaInstanceURL}]];
      const HOST_URL = [[${hostUrl}]];
      const CHANNEL = [[${channel}]];
      const LOGIN_URL = [[${loginURL}]];
      const LOGOUT_URL = [[${logoutURL}]];

      function loadGigya() {
        return new Promise((resolve, reject) => {
          let gigyaScript = document.createElement('script');
          gigyaScript.type = 'text/javascript';
          gigyaScript.async = true;
          gigyaScript.src = `https://cdns.gigya.com/js/gigya.saml.js?apiKey=${GIGYA_API_KEY}`;
          gigyaScript.innerHTML = JSON.stringify({
            loginURL: LOGIN_URL,
            logoutURL: LOGOUT_URL,
          });
          gigyaScript.onload = resolve;
          gigyaScript.onerror = reject;
          document.getElementsByTagName('head')[0].appendChild(gigyaScript);
        });
      }

      window.onload = async () => {
        try {
          const isLoggedIn = localStorage.getItem('user_uid') ?? false;
          await showLoadingSpinner();
          if (isLoggedIn) await checkUserPermission();
          await loadGigya();
        } catch(err) {
          console.error(err);
          await hideLoadingSpinner();
        }
      }

      async function getUserInfo ({UID}) {
        const {data: userInfo} = await axios.post("/getAccountInfo", {uid: UID});
        return userInfo;
      }

      async function checkUserPermission () {
        const userInfo = await getUserInfo({UID: localStorage.getItem('user_uid')});
        const APPROVAL_STATUS = userInfo.data.channels[CHANNEL]?.approvalStatus;
        const USER_STATUS = userInfo.data.userStatus;
        const isAdUser = userInfo.socialProviders.includes('saml-samsung-ad');
        const isAdLogin = new URLSearchParams(location.search).get('adLogin');

        switch (APPROVAL_STATUS) {
          case 'approved' || 'inactive':
            if (isAdLogin) signInSession.UID = response.data.results[0].UID;
            return;
          case 'pending':
            debugger;
            return location.assign(`/approval-status-error?approvalStatus=pending`);
          case 'emp-pending':
            debugger;
            return location.assign(`/approval-status-error?approvalStatus=emp-pending`);
          case 'disabled':
            debugger;
            return location.assign(`/approval-status-error?approvalStatus=disabled`);
          default:
            const SFDC = ['e2e', 'ets', 'partnerhub', 'mmp', 'edo'];

            if (isAdLogin || isAdUser) {
              signInSession.UID = response.data.results[0].UID;
              return newChannelRegister({UID: response.data.results[0].UID});
            }

            if (USER_STATUS === 'active') {
              if (SFDC.includes(CHANNEL)) return location.assign(`${HOST_URL.php}`);
              return ssoAccess();
            }

            return location.assign(`/approval-status-error?approvalStatus=pending`);
        }
      }

      function ssoAccess() {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `${HOST_URL.java}/new-channel/ssoAccess`;

        const uidInput = document.createElement('input');
        const channelInput = document.createElement('input');

        uidInput.type = 'hidden';
        uidInput.name = 'cdc_uid';
        channelInput.type = 'hidden';
        channelInput.name = 'targetChannel';

        form.appendChild(uidInput);
        form.appendChild(channelInput);

        document.body.appendChild(form);

        return form.submit();
      }

      function newChannelRegister({UID}) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `${HOST_URL.java}/new-channel/register/${CHANNEL}`;

        const regTokenInput = document.createElement('input');
        const adCdcUidInput = document.createElement('input');

        regTokenInput.type = 'hidden';
        regTokenInput.name = 'regToken';

        adCdcUidInput.type = 'hidden';
        adCdcUidInput.name = 'adCdcUid';
        adCdcUidInput.value = UID;
        console.log(UID);
        console.log(adCdcUidInput.value)

        form.appendChild(regTokenInput);
        form.appendChild(adCdcUidInput);

        document.body.appendChild(form);

        return form.submit();
      }
    </script>
  </head>
  <body>
    <th:block
        th:replace="_components/spinner/loading-spinner :: loading-spinner"
    ></th:block>
  </body>
</html>