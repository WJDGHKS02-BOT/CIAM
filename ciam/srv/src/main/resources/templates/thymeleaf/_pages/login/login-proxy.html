<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <link href="/_styles/_index.css" rel="stylesheet" />
    <link href="/_pages/login/login-page.css" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/_pages/login/sign-in-session.js"></script>
    <script src="/_components/spinner/loading-spinner.js"></script>
    <script src="/_apis/localStorage.js"></script>
    <script src="/_apis/is-update-consent.js"></script>

    <script th:inline="javascript">
      const GIGYA_API_KEY = [[${apiKey}]];
      const GIGYA_PARENT_KEYS = [[${parentKeys}]];
      const gigyaInstanceURL = [[${gigyaInstanceURL}]];
      const HOST_URL = [[${hostUrl}]];
      const CHANNEL = [[${channel}]];
      const LOGIN_URL = [[${loginURL}]];
      const LOGOUT_URL = [[${logoutURL}]];

      function loadGigya() {
        return new Promise((resolve, reject) => {
          let gigyaScript = document.createElement('script');
          gigyaScript.type = 'text/javascript';
          gigyaScript.async = true;
          gigyaScript.src = `https://cdns.gigya.com/js/gigya.saml.js?apiKey=${GIGYA_API_KEY}`;
          gigyaScript.innerHTML = JSON.stringify({
            loginURL: LOGIN_URL,
            logoutURL: LOGOUT_URL,
          });
          gigyaScript.onload = resolve;
          gigyaScript.onerror = reject;
          debugger;
          document.getElementsByTagName('head')[0].appendChild(gigyaScript);
        });
      }

      window.onload = async () => {
        try {
          await showLoadingSpinner();

          const isLoggedIn = getItemWithExpiry('user_uid') ?? false;
          if (isLoggedIn) {
            await checkUserPermission();
            await isUpdateConsent({UID: getItemWithExpiry('user_uid')});
            debugger;
          }
          debugger;
          await loadGigya();
          debugger;
        } catch(err) {
          console.error(err);
          await hideLoadingSpinner();
        }
      }

      async function checkUserPermission () {
        const {data: userInfo} = await axios.post("/getAccountInfo", {uid: getItemWithExpiry('user_uid')});
        console.log(userInfo);

        if (!userInfo) {
          debugger;
          localStorage.removeItem('user_uid');
          return await loadGigya();
        }

        const USER_STATUS = userInfo.data.userStatus;
        const isNotHaveChannel = !userInfo.data.channels
        const isAdUser = userInfo.socialProviders.split(',').includes('saml-samsung-ad');
        const params = new URLSearchParams(location.search);
        const isAdLogin = params.get('adLogin');
        const isBtpLogin = params.get('channel') === 'btp';

        if (isNotHaveChannel && (isAdUser || isAdLogin)) {
          debugger;
          return redirectNewChannel_JAVA_AD({UID: userInfo.UID});
        }

        const APPROVAL_STATUS = userInfo.data.channels[CHANNEL]?.approvalStatus;

        if (USER_STATUS === 'active' || USER_STATUS === 'inactive') {
          debugger;
          if (isBtpLogin) return;
          debugger;
          switch (APPROVAL_STATUS) {
            case 'approved':
              await axios.post('/setAccountStatus', {
                uid: getItemWithExpiry('user_uid'),
                channel: new URLSearchParams(location.search).get('channel'),
              })
              return;
            case 'inactive':
              await axios.post('/setAccountStatus', {
                uid: getItemWithExpiry('user_uid'),
                channel: new URLSearchParams(location.search).get('channel'),
              })
              return;
            case 'pending':
              debugger;
              return location.assign(`/approval-status-error?approvalStatus=pending`);
            case 'emp-pending':
              debugger;
              return location.assign(`/approval-status-error?approvalStatus=emp-pending`);
            case 'disabled':
              debugger;
              return location.assign(`/approval-status-error?approvalStatus=disabled`);
            default:
              debugger;
              const SFDC = ['e2e', 'ets', 'partnerhub', 'mmp', 'edo'];

              if (isAdUser) return redirectNewChannel_JAVA_AD({UID: userInfo.UID});

              if (SFDC.includes(CHANNEL)) return location.assign(`${HOST_URL.php}`);
              return redirectExpandChannel_JAVA(userInfo.UID, CHANNEL);
          }
        }
        else {
          debugger;
          return location.assign(`/approval-status-error?approvalStatus=disabled`);
        }
      }

      function redirectExpandChannel_JAVA(uid, channel) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `${HOST_URL.java}/new-channel/ssoAccess`;

        const uidInput = document.createElement('input');
        const channelInput = document.createElement('input');

        uidInput.type = 'hidden';
        uidInput.name = 'cdc_uid';
        uidInput.value = uid;
        channelInput.type = 'hidden';
        channelInput.name = 'targetChannel';
        channelInput.value = channel;

        form.appendChild(uidInput);
        form.appendChild(channelInput);

        document.body.appendChild(form);

        return form.submit();
      }

      function redirectNewChannel_JAVA_AD({UID}) {
        // const regToken = new URLSearchParams(location.search).get('regToken') ?? false;
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `${HOST_URL.java}/new-channel/register/${CHANNEL}`;

        const regTokenInput = document.createElement('input');
        const adCdcUidInput = document.createElement('input');

        regTokenInput.type = 'hidden';
        regTokenInput.name = 'regToken';
        // if (regToken) regTokenInput.value = regToken;

        adCdcUidInput.type = 'hidden';
        adCdcUidInput.name = 'adCdcUid';
        adCdcUidInput.value = UID;

        form.appendChild(regTokenInput);
        form.appendChild(adCdcUidInput);

        document.body.appendChild(form);

        return form.submit();
      }
    </script>
  </head>
  <body>
    <th:block
        th:replace="_components/spinner/loading-spinner :: loading-spinner"
    ></th:block>
  </body>
</html>